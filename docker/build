#!/bin/bash

# Konfigur√°cia
CONTAINER_NAME="rshop-app"
DOCKERFILE="Dockerfile"
BUILD_CONTEXT="."
VERSION="master"
CONFIG="app_db_lite.php"
PORT="8885:80"

# Zastavenie a vymazanie existuj√∫ceho containeru
if [ "$(docker ps -aq -f name=$CONTAINER_NAME)" ]; then
    echo "‚ö† Stopping and removing existing container $CONTAINER_NAME..."
    docker stop "$CONTAINER_NAME"
    docker rm "$CONTAINER_NAME"
fi

# Odstr√°nenie existuj√∫ceho image
if [ "$(docker images -q $CONTAINER_NAME)" ]; then
    echo "üóë Removing existing image $CONTAINER_NAME..."
    docker rmi "$CONTAINER_NAME:latest"
fi

# Build nov√©ho image
echo "üõ† Building Docker image for $CONTAINER_NAME..."
docker build \
    --no-cache \
    --file "$DOCKERFILE" \
    --build-arg VERSION="$VERSION" \
    --build-arg CONFIG="$CONFIG" \
    -t "$CONTAINER_NAME:latest" \
    "$BUILD_CONTEXT"

if [ $? -ne 0 ]; then
    echo "‚ùå Build failed"
    exit 1
fi

# Spustenie nov√©ho containeru
echo "‚ñ∂ Running container $CONTAINER_NAME..."
docker run -d \
    --name "$CONTAINER_NAME" \
    -p "$PORT" \
    --restart unless-stopped \
    "$CONTAINER_NAME:latest"

if [ $? -eq 0 ]; then
    echo "‚úÖ Container $CONTAINER_NAME is running on port ${PORT%:*}"
else
    echo "‚ùå Failed to run container $CONTAINER_NAME"
fi
